# name: CI/CD Pipeline

# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#       - main


# jobs: 

#     build:
#       runs-on: ubuntu-latest
#       steps:
#         - name: Checkout code
#           uses: actions/checkout@v4

#         - name: Set up Node.js
#           uses: actions/setup-node@v4
#           with:
#             node-version: "24"
#             cache: 'npm'

#         - name: Install system dependencies for sharp
#           run: sudo apt-get update && sudo apt-get install -y libvips-dev

#         - name: Install dependencies
#           run: npm install

#         - name: Build Next.js app
#           run: npm run build

#         # - name: Copy static assets
#         #   run: cp -r public build/standalone/ && cp -r build/static build/standalone/build/
#         - name: Copy static assets
#           run: |
#             # Create the necessary directory structure first
#             mkdir -p build/standalone/build/
            
#             # Now copy the assets into the existing structure
#             cp -r public build/standalone/
#             cp -r build/static build/standalone/build/


#         - name: Upload build artifact
#           uses: actions/upload-artifact@v4
#           with:
#             name: nextjs-build
#             path: |
#               ./
#               !node_modules/

#     build-and-deploy:
#       runs-on: self-hosted
#       needs: build
#       steps:  
#           - name: Checkout code
#             uses: actions/checkout@v3

#           - name: Receive the artifact
#             uses: actions/download-artifact@v4
#             with:
#               name: nextjs-build
          
#           - name: Show the artifact
#             run: 
#               ls -a

#           - name: Deploy application
#             run: |
#               ls -a
#               pm2 status
#               # stop existing process if running
#               pm2 delete node-app || true

#               # start new process
#               # pm2 start "serve .next/static -p 3000" --name=node-app
#               pm2 start "node build/standalone/server.js" --name=node-app

#               # same PM2 process list
#               pm2 save

#           # - name: Install and run serve package
#           #   run: |
#           #     npm install -g serve
#           #     serve .next/static -p 3000
    

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs: 

    build:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version: "24"
            cache: 'npm'

        - name: Install system dependencies for sharp
          run: sudo apt-get update && sudo apt-get install -y libvips-dev

        - name: Install dependencies
          run: npm install

        - name: Build Next.js app
          run: npm run build

        - name: Copy static assets
          run: |
            # Create the necessary .next directory inside the standalone output folder.
            mkdir -p build/standalone/.next/
            
            # 1. Copy assets from the 'public' folder into the standalone distribution
            cp -r public build/standalone/
            
            # 2. Copy the compiled client-side static assets (JS, CSS, etc.)
            # Source: .next/static (where Next.js puts the compiled assets)
            # Destination: build/standalone/.next/ (ensuring static is available to the server)
            cp -r .next/static build/standalone/.next/

        - name: Upload build artifact
          uses: actions/upload-artifact@v4
          with:
            name: nextjs-build
            # Upload the entire root directory, excluding node_modules
            path: |
              ./
              !node_modules/

    build-and-deploy:
      runs-on: self-hosted
      needs: build
      steps:  
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Receive the artifact
            uses: actions/download-artifact@v4
            with:
              name: nextjs-build
          
          - name: Show the artifact
            run: 
              ls -a

          - name: Install PM2 globally
            run: npm install -g pm2

          - name: Deploy application
            run: |
              ls -a
              pm2 status
              # stop existing process if running
              pm2 delete node-app || true

              # start new process
              pm2 start "node build/standalone/server.js" --name=node-app

              # same PM2 process list
              pm2 save